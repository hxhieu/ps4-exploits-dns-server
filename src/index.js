import dns from 'native-dns';
import express from 'express';
import util from 'util';

import { requestHandler } from './handlers/request';
import { errorHandler, socketErrorHandler } from './handlers/error';
import { logInfo } from './utils/logger';

const server = dns.createServer();

const address = () => `${server.address().address}`;

server.on('listening', () => logInfo(`DNS listening on ${address()}`));
server.on('close', () => logInfo(`DNS closed ${address()}`));
server.on('error', errorHandler);
server.on('socketError', socketErrorHandler);
server.on('request', requestHandler);
server.serve(53);

const app = express();
app.get('*', (req, res) => res.send(util.inspect(req.url)));
app.listen(80, () => logInfo(`HTTP listening on ${address()}`));
